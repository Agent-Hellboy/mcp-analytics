name: ci

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: false  # Disable caching since this is a multi-module project

      - name: Build and test services
        run: |
          set -euo pipefail
          for svc in services/api services/ingest services/processor services/ui services/mcp-server services/mcp-proxy; do
            echo "üî® Building and testing $svc"
            (cd "$svc" && go build -o "$(basename "$svc")" . && go test ./... -v)
          done


      - name: Check Go version consistency
        run: |
          set -euo pipefail
          echo "üîç Checking Go version consistency across services"
          versions=$(for svc in services/*/go.mod; do
            if [ -f "$svc" ]; then
              grep "^go " "$svc" | sed 's/go //' || echo "no version found in $svc"
            fi
          done | sort | uniq)
          version_count=$(echo "$versions" | grep -v '^$' | wc -l)
          if [ "$version_count" -gt 1 ]; then
            echo "‚ö†Ô∏è  Multiple Go versions found:"
            echo "$versions" | grep -v '^$'
            echo "Consider standardizing on a single Go version"
          elif [ "$version_count" -eq 1 ]; then
            echo "‚úÖ All services use Go version: $(echo "$versions" | grep -v '^$')"
          else
            echo "‚ö†Ô∏è  No Go versions found in go.mod files"
          fi

      - name: Build Docker images
        run: |
          set -euo pipefail
          echo "üê≥ Building Docker images for testing"
          if ! command -v docker >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Docker not available, skipping Docker build tests"
            exit 0
          fi
          for svc in api ingest processor ui mcp-server mcp-proxy; do
            dockerfile="services/$svc/Dockerfile"
            if [ -f "$dockerfile" ]; then
              echo "Building $dockerfile"
              docker build -f "$dockerfile" -t "mcp-$svc:test" "services/$svc"
            else
              echo "‚ö†Ô∏è  Dockerfile not found: $dockerfile"
            fi
          done
          echo "‚úÖ All Docker images built successfully"

      - name: Smoke test binaries
        run: |
          set -euo pipefail
          echo "üöÄ Running smoke tests on compiled binaries"
          for svc in services/api services/ingest services/processor services/ui services/mcp-server services/mcp-proxy; do
            binary_name=$(basename "$svc")
            binary_path="$svc/$binary_name"
            if [ -f "$binary_path" ] && [ -x "$binary_path" ]; then
              echo "Testing $svc binary integrity"
              # Check if binary is valid executable (try file command, fallback to basic check)
              if command -v file >/dev/null 2>&1 && file "$binary_path" | grep -q "ELF.*executable"; then
                echo "‚úÖ $svc: Binary is valid ELF executable"
              elif [ -x "$binary_path" ]; then
                echo "‚úÖ $svc: Binary is executable"
              else
                echo "‚ö†Ô∏è  $svc: Binary exists but not executable"
                continue
              fi

              # Try to run for 1 second - expect graceful failure due to missing env/config
              # These services need ClickHouse, Kafka, etc. so they should fail but not crash
              if timeout 2s "$binary_path" 2>/dev/null; then
                echo "‚ö†Ô∏è  $svc: Binary started unexpectedly (might indicate missing dependencies)"
              else
                echo "‚úÖ $svc: Binary fails gracefully (expected without config)"
              fi
            else
              echo "‚ùå $svc: Binary not found or not executable at $binary_path"
            fi
          done

      - name: Validate manifests
        run: |
          set -euo pipefail
          curl -sSL -o /tmp/kubeconform.tar.gz https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          # Note: Checksum verification for kubeconform would be added here if available
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp kubeconform
          chmod +x /tmp/kubeconform
          /tmp/kubeconform -kubernetes-version 1.34.0 -summary -strict k8s/*.yaml
